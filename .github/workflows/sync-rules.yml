# .github/workflows/sync-rules.yml

name: Sync, Sanitize, and Compile to MRS (Final Stable Binary)

on:
  workflow_dispatch:
  schedule:
    - cron: '0 21 * * *' # 北京时间每日早晨 5 点

jobs:
  sync-job:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      # =================================================================
      # 核心修正：使用一个当前确认有效的预编译二进制文件下载链接
      # =================================================================
      - name: Download and Install mrs-generator
        run: |
          echo "Downloading pre-compiled mrs-generator binary from a new stable source..."
          # 这个链接指向一个当前可用的、由社区维护的二进制文件
          curl -sSL https://github.com/xchacha20-poly1305/mrs-generator/releases/download/v0.0.4/mrs-generator-linux-amd64 -o mrs-generator
          
          echo "Installing binary..."
          # 确认下载下来的不是 "Not Found" 文本
          if grep -q "Not Found" ./mrs-generator; then
            echo "Error: Download failed, received 'Not Found' page."
            exit 1
          fi

          # 赋予执行权限并移动
          chmod +x ./mrs-generator
          sudo mv ./mrs-generator /usr/local/bin/mrs-generator
          
          echo "Verifying installation..."
          # 验证工具
          mrs-generator -h

      # =================================================================
      # 后续阶段完全不变
      # =================================================================

      # 阶段一：同步原始规则文件
      - name: Sync & Prune Source Files
        run: |
          echo "### Phase 1: Syncing source files ###"
          if [ ! -f sources.urls ]; then echo "sources.urls not found, skipping."; exit 0; fi
          touch expected_files.list && grep -v '^#' sources.urls | grep -v '^$' | while read -r url; do project_name=$(echo "${url}" | awk -F/ '{print $4}'); original_filename=$(basename "${url}"); echo "rulesets/${project_name}/${original_filename}" >> expected_files.list; done
          touch actual_files.list && { [ -d "rulesets" ] && find rulesets -type f > actual_files.list || true; }
          sort actual_files.list -o actual_files.list && sort expected_files.list -o expected_files.list
          comm -23 actual_files.list expected_files.list | while read -r file; do if [ -n "$file" ]; then echo "Pruning source: ${file}"; rm "$file"; fi; done
          grep -v '^#' sources.urls | grep -v '^$' | while read -r url; do project_name=$(echo "${url}" | awk -F/ '{print $4}'); original_filename=$(basename "${url}"); target_path="rulesets/${project_name}/${original_filename}"; echo "Syncing source: ${target_path}"; curl -sS -L --create-dirs -o "${target_path}" "${url}"; done
          [ -d "rulesets" ] && find rulesets -type d -empty -delete || true
          echo "### Source sync complete. ###"

      # 阶段二：清洗、编译和清理 MRS 文件
      - name: Sanitize, Compile to MRS & Prune
        run: |
          echo "### Phase 2: Sanitizing and Compiling to .mrs ###"
          MRS_DIR="mrs-rules"
          SOURCE_DIR="rulesets"
          touch expected_mrs.list
          if [ -d "$SOURCE_DIR" ]; then find "$SOURCE_DIR" -type f | sed "s|^$SOURCE_DIR/|$MRS_DIR/|; s|\.[^.]*$|.mrs|" >> expected_mrs.list; fi
          touch actual_mrs.list && { [ -d "$MRS_DIR" ] && find "$MRS_DIR" -type f -name "*.mrs" > actual_mrs.list || true; }
          sort actual_mrs.list -o actual_mrs.list && sort expected_mrs.list -o expected_mrs.list
          comm -23 actual_mrs.list expected_mrs.list | while read -r file; do if [ -n "$file" ]; then echo "Pruning .mrs: ${file}"; rm "$file"; fi; done
          if [ -d "$SOURCE_DIR" ]; then
            find "$SOURCE_DIR" -type f | while read -r source_file_path; do
              echo "Sanitizing: ${source_file_path}"
              SANITIZED_TMP_FILE="${source_file_path}.tmp"
              grep -v -E '^#|^!' "${source_file_path}" | grep -v -E '^\s*$' | while read -r line; do
                  line=$(echo "$line" | xargs)
                  if [ -z "$line" ]; then continue; fi
                  if [[ "$line" == *,* ]]; then
                      echo "$line" >> "${SANITIZED_TMP_FILE}"
                  else
                      echo "DOMAIN-SUFFIX,${line}" >> "${SANITIZED_TMP_FILE}"
                  fi
              done
              mv "${SANITIZED_TMP_FILE}" "${source_file_path}"
              mrs_file_path=$(echo "$source_file_path" | sed "s|^$SOURCE_DIR/|$MRS_DIR/|; s|\.[^.]*$|.mrs|")
              echo "Compiling: ${source_file_path} -> ${mrs_file_path}"
              mkdir -p "$(dirname "${mrs_file_path}")"
              mrs-generator -i "${source_file_path}" -o "${mrs_file_path}"
            done
          fi
          [ -d "$MRS_DIR" ] && find "$MRS_DIR" -type d -empty -delete || true
          echo "### .mrs compilation complete. ###"

      # 阶段三：提交所有变更
      - name: Commit All Changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore(auto-sync): Sync, sanitize, and compile"
          branch: main
       
